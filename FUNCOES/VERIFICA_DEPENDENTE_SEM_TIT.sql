USE [ADMIX_CORP]
GO

/****** Object:  UserDefinedFunction [dbo].[VERIFICA_DEPENDENTE_SEM_TIT]    Script Date: 04/11/2014 11:20:26 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO










-- VERIFICAR A DEPENDENTE SEM TITULAR NO ARQUIVO
CREATE FUNCTION [dbo].[VERIFICA_DEPENDENTE_SEM_TIT](@MATRICULA VARCHAR(50), @ID_CARGA INT, @OPERADORA VARCHAR(4),@APOLICE VARCHAR(20))
RETURNS BIT
AS
BEGIN
	DECLARE	@QUERY VARCHAR(255)
	DECLARE	@RETURN BIT;

	IF(	SELECT COUNT(1) FROM DB_ADMIX_IN.dbo.ADMIX_MOV WHERE CD_MATRICULA = @MATRICULA AND RIGHT('00' + CD_PARENTESCO,2) = '00' AND ID_LOG_RECEPCAO = @ID_CARGA) >= 1
		SET @RETURN=1;
		ELSE
			IF(
			SELECT COUNT(1)	FROM DW_SA.dbo.SA_SMC_SEGURADO_TIT_PORTAL
			WHERE (1=1)
			AND CD_OPERADORA_PORTAL = RIGHT('0000' + @OPERADORA,4)
			AND RIGHT(REPLICATE('0',20) + LTRIM(RTRIM(CD_APOLICE)), 20) = RIGHT(REPLICATE('0',20) + @APOLICE, 20) 
			AND CD_CODIGO_EXTERNO = RIGHT(REPLICATE('0',20) + @MATRICULA,20)
			)>0
				SET @RETURN = 1
				ELSE
					SET @RETURN = 0
			

	RETURN @RETURN;
END 
/*
00000000000000004193
SELECT * FROM DW_SA.dbo.SA_SMC_SEGURADO_TIT_PORTAL
WHERE (1=1)
AND CD_OPERADORA_PORTAL = RIGHT('0000' + '005',4)
AND CD_CODIGO_EXTERNO = RIGHT(REPLICATE('0',20) + '94337',20)
AND RIGHT(REPLICATE('0',20) + LTRIM(RTRIM(CD_APOLICE)), 20) = RIGHT(REPLICATE('0',20) + '00000000000000004193', 20) 

00000000000000004193
00000000000000004193

SELECT * FROM DW_SA.dbo.SA_SMC_SEGURADO_TIT_PORTAL WHERE CD_APOLICE LIKE '%4193'
94337	005	00000000000000004193
SELECT dbo.VERIFICA_DEPENDENTE_SEM_TIT('94337',76041, '005','00000000000000004193')
SELECT dbo.VERIFICA_DEPENDENTE_SEM_TIT('94337',76041, '005','4193')
*/
--SELECT dbo.VERIFICA_DEPENDENTE_SEM_TIT('00000000000000089000',40417, '026','00000000000000096852')
--SELECT dbo.VERIFICA_DEPENDENTE_SEM_TIT('00000000000000052000',40417, '026','00000000000000096852')

/*
SELECT * FROM DW_SA..SA_SMC_SEGURADO_TIT_PORTAL WHERE NM_PESSOA LIKE '%RUAS'

000000000000

SELECT COUNT(1)	
FROM DW_SA..SA_SMC_SEGURADO_TIT_PORTAL
WHERE (1=1)
AND CD_OPERADORA_PORTAL = RIGHT('0000' + '1',4)
AND CD_APOLICE = RIGHT(REPLICATE('0',20) + '00000000000000008500', 20) 
AND CD_CODIGO_EXTERNO = RIGHT(REPLICATE('0',20) + '1048',20)




--FUNCAO ANTIGA - 16/03/2010
	DECLARE	@QUERY VARCHAR(255)
	DECLARE	@RETURN BIT;

	IF(	SELECT COUNT(1) FROM DB_ADMIX_IN..ADMIX_MOV WHERE CD_MATRICULA = @MATRICULA AND RIGHT('00' + CD_PARENTESCO,2) = '00' AND ID_LOG_RECEPCAO = @ID_CARGA) >= 1
		SET @RETURN=1;
		ELSE
			IF(
			SELECT COUNT(1)	FROM DB_ADMIX_ODS..AD_SEGURADO SEG 
			INNER JOIN SRV_SQL04.PORTAL_ADMIX.dbo.AD_PAPEL_RELACIONAMENTO PAP ON(SEG.ID_AD_SEGURADO = PAP.ID_PAPEL_RELACIONAMENTO)	
			INNER JOIN SRV_SQL04.PORTAL_ADMIX.dbo.AD_PESSOA_FISICA FIS ON(FIS.ID_PESSOA = PAP.ID_PESSOA)
			INNER JOIN SRV_SQL04.PORTAL_ADMIX.dbo.AD_PESSOA PES ON(PES.ID_PESSOA = FIS.ID_PESSOA)
			WHERE SEG.CD_GRAU_PARENTESCO = -2 
			AND SEG.CD_OPERADORA = RIGHT('0000' + @OPERADORA,4)
			AND RIGHT(REPLICATE('0',20) + LTRIM(RTRIM(SEG.CD_CONTRATO)),20) = RIGHT(REPLICATE('0',20) + @APOLICE, 20) 
			AND SEG.CD_MATRICULA = RIGHT('00000000000' + @MATRICULA,11)
			OR RIGHT('000000000000' + REPLACE(SEG.CD_MATRICULA_ESPECIAL,' ',''),12) = RIGHT('000000000000' + @MATRICULA,12)
			)>0
				SET @RETURN = 1
				ELSE
					SET @RETURN = 0
			

	RETURN @RETURN;
*/




















GO


